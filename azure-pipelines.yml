# Build the surge-fx with JUCE buidls

trigger:
- master

pr:
- master

jobs:
- job: Build
  strategy:
    matrix:
      mac10:
        imageName: 'macos-10.13'
        isMac: true
      win:
        imageName: 'vs2017-win2016'
        isWindows: true

  pool:
    vmImage: $(imageName)

  steps:
  - checkout: self
    fetchDepth: 1
    # submodules: recursive # can't do submodules here b'cuz depth=1 fails with Github


  - bash: |
      git submodule update --init --recursive
    displayName: Get Surge SubModule

  - bash: |
      make -f Makefile.mac dmg
      mkdir products/
      mv *dmg products
    displayName: Build Mac Plugins
    condition: variables.isMac

  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'MACOS_BUILD'
      targetPath: 'products/'
    displayName: Publish Mac DMG
    condition: variables.isMac

  - bash: |
      mkdir assets
      mkdir products
      curl -o assets/juce-5.4.3-windows.zip https://d30pueezughrda.cloudfront.net/juce/juce-5.4.3-windows.zip   
      cd assets
      unzip juce-5.4.3-windows.zip
      cd ..
      assets/JUCE/Projucer.exe --resave surge-fx.jucer   
    displayName: Build Windows sln file
    condition: variables.isWindows

  - task: MSBuild@1
    inputs:
      solution: 'Builds\VisualStudio2017\surge-fx.sln'
      maximumCpuCount: true
      platform: 'x64'
      configuration: 'Release'
    condition: variables.isWindows
    displayName: Build Windows x64

  - bash: |
      cd Builds/VisualStudio2017/x64
      7z.exe a ..\..\..\products\surge-fx-win.zip Release
    displayName: Build Windows sln file
    condition: variables.isWindows

  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'WINDOWS_BUILD'
      targetPath: 'products/'
    displayName: Publish Windows Zip
    condition: variables.isWindows


- job: UpdateGithubRelease
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))

  steps:
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'MACOS_BUILD'
      targetPath: $(Build.ArtifactStagingDirectory)

  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'WINDOWS_BUILD'
      targetPath: $(Build.ArtifactStagingDirectory)

  - bash: |
     scripts/release-notes.sh > $(Build.ArtifactStagingDirectory)/ReleaseNotes.md
    displayName: Fake up release notes

  - task: GitHubRelease@0
    displayName: "Update Github Release"
    inputs:
      gitHubConnection: surge-rackupdater
      repositoryName: surge-synthesizer/surge-fx
      action: edit
      tag: Nightly
      target: '$(Build.SourceVersion)'
      addChangeLog: false
      releaseNotesFile: $(Build.ArtifactStagingDirectory)/ReleaseNotes.md
      assets: $(Build.ArtifactStagingDirectory)/*.dmg

